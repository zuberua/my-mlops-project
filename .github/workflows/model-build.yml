name: Model Build Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'pipelines/**'
      - 'preprocessing/**'
      - 'training/**'
      - 'evaluation/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run pipeline'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  SAGEMAKER_PROJECT_NAME: mlops-demo
  PYTHON_VERSION: '3.10'

jobs:
  build-and-train:
    name: Build and Train Model
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          echo "=== Installed packages ==="
          pip list | grep -E "(sagemaker|boto3)"
          echo "=== Testing sagemaker import ==="
          python -c "import sagemaker; print('SageMaker imported successfully')"
          python -c "from sagemaker.workflow.pipeline import Pipeline; print('Pipeline module found')"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ModelBuild

      - name: Run tests
        run: |
          pytest tests/ -v --cov=pipelines --cov-report=term-missing

      - name: Create or Update SageMaker Pipeline
        id: pipeline
        run: |
          python pipelines/create_pipeline.py \
            --region ${{ env.AWS_REGION }} \
            --role ${{ secrets.SAGEMAKER_EXECUTION_ROLE_ARN }} \
            --project-name ${{ env.SAGEMAKER_PROJECT_NAME }}
          
          echo "pipeline_arn=$(cat pipeline_arn.txt)" >> $GITHUB_OUTPUT

      - name: Start SageMaker Pipeline Execution
        id: execution
        run: |
          python pipelines/run_pipeline.py \
            --pipeline-name ${{ env.SAGEMAKER_PROJECT_NAME }}-pipeline \
            --region ${{ env.AWS_REGION }}
          
          echo "execution_arn=$(cat execution_arn.txt)" >> $GITHUB_OUTPUT

      - name: Wait for Pipeline Completion
        run: |
          python pipelines/wait_pipeline.py \
            --execution-arn ${{ steps.execution.outputs.execution_arn }} \
            --region ${{ env.AWS_REGION }} \
            --timeout 3600

      - name: Get Pipeline Results
        id: results
        run: |
          python pipelines/get_results.py \
            --execution-arn ${{ steps.execution.outputs.execution_arn }} \
            --region ${{ env.AWS_REGION }}

      - name: Upload Pipeline Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifacts
          path: |
            pipeline_arn.txt
            execution_arn.txt
            results.json

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));
            
            const comment = `## ü§ñ Model Training Results
            
            **Pipeline Execution:** \`${{ steps.execution.outputs.execution_arn }}\`
            **Status:** ${results.status}
            **Model Accuracy:** ${results.accuracy}
            **Model Package ARN:** ${results.model_package_arn || 'N/A'}
            
            ${results.status === 'Succeeded' ? '‚úÖ Model registered successfully!' : '‚ùå Pipeline failed'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  register-model:
    name: Register Model
    needs: build-and-train
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install boto3 sagemaker

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pipeline-artifacts

      - name: Approve Model for Deployment
        run: |
          python scripts/approve_model.py \
            --results-file results.json \
            --region ${{ env.AWS_REGION }}
